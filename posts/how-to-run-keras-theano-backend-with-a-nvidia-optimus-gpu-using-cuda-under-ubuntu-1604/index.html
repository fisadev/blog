<!DOCTYPE html>
<html prefix="" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>How to run Keras (Theano backend) with a Nvidia Optimus gpu using CUDA, under Ubuntu 16.04 | Blog (fisa)</title>
<link href="../../assets/css/all.css" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../rss.xml">
<link rel="canonical" href="http://blog.fisadev.com/posts/how-to-run-keras-theano-backend-with-a-nvidia-optimus-gpu-using-cuda-under-ubuntu-1604/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Juan Pedro Fisanotti">
<link rel="prev" href="../suspicious-logins/" title="Suspicious logins" type="text/html">
<link rel="next" href="../como-saber-si-hay-un-satelite-argentino-arriba-tuyo/" title="Cómo saber si hay un satélite argentino arriba tuyo" type="text/html">
<meta property="og:site_name" content="Blog (fisa)">
<meta property="og:title" content="How to run Keras (Theano backend) with a Nvidia Optimus gpu using CUDA">
<meta property="og:url" content="http://blog.fisadev.com/posts/how-to-run-keras-theano-backend-with-a-nvidia-optimus-gpu-using-cuda-under-ubuntu-1604/">
<meta property="og:description" content="I broke so many things trying to get this to work, that I need to write it down for my future self and any others who might need this.
This tutorial explains how to get a Keras neural network to train">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2016-09-20T22:58:35-03:00">
<meta property="article:tag" content="cuda">
<meta property="article:tag" content="keras">
<meta property="article:tag" content="machine learning">
<meta property="article:tag" content="programming">
<meta property="article:tag" content="python">
<meta property="article:tag" content="ubuntu">
</head>
<body>
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
            styles, `#sidebar-checkbox` for behavior. -->
    <input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox"><!-- Toggleable sidebar --><div class="sidebar" id="sidebar">
        <div class="sidebar-item">
            <p>A reserved <a href="https://getnikola.com" target="_blank">Nikola</a> theme that places the utmost gravity on content with a hidden drawer. Made by <a href="https://twitter.com/mdo" target="_blank">@mdo</a> for Jekyll,
            ported to Nikola by <a href="https://twitter.com/ralsina" target="_blank">@ralsina</a>.</p>
        </div>
        
    <nav id="menu" role="navigation" class="sidebar-nav"><a class="sidebar-nav-item" href="../../archive.html">Archive</a>
        <a class="sidebar-nav-item" href="../../categories/">Tags</a>
        <a class="sidebar-nav-item" href="../../rss.xml">RSS feed</a>
    
    
    </nav>
</div>

    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          
    <h3 id="brand" class="masthead-title">
      <a href="http://blog.fisadev.com/" title="Blog (fisa)" rel="home">Blog (fisa)</a>
    </h3>

        </div>
      </div>

      <div class="container content" id="content">
        
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="post-title p-name entry-title" itemprop="headline name"><a href="." class="u-url">How to run Keras (Theano backend) with a Nvidia Optimus gpu using CUDA, under Ubuntu 16.04</a></h1>

        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">Juan Pedro Fisanotti</span></p>
            <p class="dateline"><a href="." rel="bookmark"><time class="post-date published dt-published" datetime="2016-09-20T22:58:35-03:00" itemprop="datePublished" title="2016-09-20 22:58">2016-09-20 22:58</time></a></p>
                <p class="commentline">
    
    <a href="#disqus_thread" data-disqus-identifier="cache/posts/how-to-run-keras-theano-backend-with-a-nvidia-optimus-gpu-using-cuda-under-ubuntu-1604.html">Comments</a>


        </p>
</div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p>I broke so many things trying to get this to work, that I need to write it down for my future self and any others who might need this.</p>
<p>This tutorial explains how to get a Keras neural network to train using your gpu, or any Theano related code for that matter, but for the special scenario of having a Nvidia Optimus enabled gpu running under Ubuntu 16.04.
Other scenarios:</p>
<ul class="simple">
<li><p>Under Ubuntu 16.04 and you have a Nvidia gpu which is not Optimus enabled? then some things might work, but the "Nvidia gpu drivers" section won't be useful to you.</p></li>
<li><p>Under a different distro or Ubuntu version? I would <strong>not</strong> recommend trying this.</p></li>
<li><p>Have an non-Nvidia gpu? this <strong>won't work</strong> at all.</p></li>
</ul>
<p>Enough presentations, lets get to work.</p>
<section id="the-example"><h2>0. The example</h2>
<p>We will need a Keras example to check if things are working well.
Use the code from <a class="reference external" href="https://github.com/fisadev/keras_experiments">this repo</a>.</p>
<p>In that repo you will find a keras experiment (in one of the ipython notebooks), and a small script to check for gpu usage from Theano.
Both will be useful.</p>
<p><strong>Remember</strong> to create a virtualenv and <strong>install its dependencies</strong> (from the <code class="docutils literal">requirements.txt</code>).
You can use wheels to speed up the process. And it requires <strong>python 3</strong>.</p>
</section><section id="nvidia-gpu-drivers"><h2>1. Nvidia gpu drivers</h2>
<p>We need Ubuntu to be able to use our gpu.
To achieve that, we need both the gpu drivers and the Optimus drivers.
Thing is, Optimus drivers are kind of broken right now under Ubuntu 16.04.</p>
<p>But we can get things working, with some small annoyances:</p>
<ol class="arabic simple">
<li><p>Disconnect any external/secondary monitors.</p></li>
<li><p>Install video and optimus drivers: <code class="docutils literal">sudo apt install <span class="pre">nvidia-361</span> <span class="pre">nvidia-prime</span></code></p></li>
<li><p>Reboot your machine and login.</p></li>
<li><p>Open the "Nvidia X Server Settings" app, go to the "PRIME Profiles" section and choose "NVIDIA".</p></li>
<li><p>Close the settings app.</p></li>
<li><p>Logout and login again, so the profile change can take effect.</p></li>
</ol>
<p><strong>A small annoyance</strong>: while the "NVIDIA" profile is active you cannot (at the moment) use a secondary screen.
It will crash your X server.</p>
<p><strong>Important</strong>: remember to go back to the "Intel" profile whenever you don't want to use your gpu anymore, logout and login back for it to take effect.
Otherwise, your gpu will be using lots of power for nothing.</p>
</section><section id="cuda"><h2>2. CUDA</h2>
<p>We need to be able to do general purpose computation on our Nvidia gpu.
To achieve that, we need the CUDA toolkit.
Thing is, CUDA has no Ubuntu 16.04 package at the moment.</p>
<p>But we can make things work. This is Linux, after all (thanks to Martin Thoma's <a class="reference external" href="http://askubuntu.com/questions/799184/how-can-i-install-cuda-on-ubuntu-16-04">answer</a>):</p>
<ol class="arabic simple">
<li><p>Download CUDA from the <a class="reference external" href="https://developer.nvidia.com/cuda-downloads">Nvidia website</a>. Choose the Ubuntu 15.04 "runfile (local)" version.</p></li>
<li><p>Check the md5 sum with: <code class="docutils literal">md5sum cuda_7.5.18_linux.run</code>. Only continue if it is correct.</p></li>
<li><p>Run the installer and follow the instructions: <code class="docutils literal">sudo sh cuda_7.5.18_linux.run <span class="pre">--override</span></code>. <strong>Make sure</strong> that you say <strong>y</strong> for the symbolic link, and <strong>n</strong> to the video drivers installation.</p></li>
</ol>
<p>Don't worry about the warning related to the non-installation of the video drivers.
The script is somewhat dumb and doesn't detect the drivers we installed on the previous section.</p>
</section><section id="gcc-and-g-versions"><h2>3. Gcc and G++ versions</h2>
<p>Guess what? Yes, more problems.</p>
<p>CUDA requires gcc to be a version up to 4.9.
Later versions won't work.
Ubuntu 16.04 ships with gcc 5.4.</p>
<p>But we can have both versions side by side, and trick CUDA to use the older versions with just some simple symlinks (thanks to <a class="reference external" href="https://twitter.com/_zzzoom_/status/765720104868904964">charlie</a> for the tip, the old solution was far more complicated).</p>
<div class="code"><pre class="code bash"><a id="rest_code_1067b7a2d4c845fdb263aae487a9e1ff-1" name="rest_code_1067b7a2d4c845fdb263aae487a9e1ff-1" href="#rest_code_1067b7a2d4c845fdb263aae487a9e1ff-1"></a>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>gcc-4.9<span class="w"> </span>g++-4.9
<a id="rest_code_1067b7a2d4c845fdb263aae487a9e1ff-2" name="rest_code_1067b7a2d4c845fdb263aae487a9e1ff-2" href="#rest_code_1067b7a2d4c845fdb263aae487a9e1ff-2"></a>sudo<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/usr/bin/gcc-4.9<span class="w">  </span>/usr/local/cuda/bin/gcc
<a id="rest_code_1067b7a2d4c845fdb263aae487a9e1ff-3" name="rest_code_1067b7a2d4c845fdb263aae487a9e1ff-3" href="#rest_code_1067b7a2d4c845fdb263aae487a9e1ff-3"></a>sudo<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/usr/bin/g++-4.9<span class="w">  </span>/usr/local/cuda/bin/g++
<a id="rest_code_1067b7a2d4c845fdb263aae487a9e1ff-4" name="rest_code_1067b7a2d4c845fdb263aae487a9e1ff-4" href="#rest_code_1067b7a2d4c845fdb263aae487a9e1ff-4"></a>
<a id="rest_code_1067b7a2d4c845fdb263aae487a9e1ff-5" name="rest_code_1067b7a2d4c845fdb263aae487a9e1ff-5" href="#rest_code_1067b7a2d4c845fdb263aae487a9e1ff-5"></a><span class="c1"># Work around a glibc bug (according to the theano docs)</span>
<a id="rest_code_1067b7a2d4c845fdb263aae487a9e1ff-6" name="rest_code_1067b7a2d4c845fdb263aae487a9e1ff-6" href="#rest_code_1067b7a2d4c845fdb263aae487a9e1ff-6"></a><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">"\n[nvcc]\nflags=-D_FORCE_INLINES\n"</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>~/.theanorc
</pre></div>
</section><section id="testing"><h2>4. Testing</h2>
<p>Done! You should be able to run Theano things (including Keras neural networks) using your gpu.</p>
<p>A simple way to check if that's true, is to run the <code class="docutils literal">test_gpu.py</code> script from the example repo.
But don't just "run" it.
You need to tell Theano "hey, I want you to use my shiny cuda gpu".
To achieve that, run the script like this (inside your virtualenv):</p>
<div class="code"><pre class="code bash"><a id="rest_code_40dd64eed89745a89680f9936d295a8f-1" name="rest_code_40dd64eed89745a89680f9936d295a8f-1" href="#rest_code_40dd64eed89745a89680f9936d295a8f-1"></a><span class="nv">THEANO_FLAGS</span><span class="o">=</span><span class="s2">"mode=FAST_RUN,device=gpu,floatX=float32,cuda.root=/usr/local/cuda/"</span><span class="w"> </span>python<span class="w"> </span>test_gpu.py
</pre></div>
<p>If everything is working, it should quickly run and output something which ends with: <code class="docutils literal">Used the gpu</code>.
If instead it takes a long time (~1 minute) and ends with <code class="docutils literal">Used the cpu</code>, then something is not working.</p>
<p>If that worked, then you can try the full example and play a little with it (should be able to run all lines without errors):</p>
<div class="code"><pre class="code bash"><a id="rest_code_235cbfdf50304184afc44b2c9c97c6e1-1" name="rest_code_235cbfdf50304184afc44b2c9c97c6e1-1" href="#rest_code_235cbfdf50304184afc44b2c9c97c6e1-1"></a><span class="nv">THEANO_FLAGS</span><span class="o">=</span><span class="s2">"mode=FAST_RUN,device=gpu,floatX=float32,cuda.root=/usr/local/cuda/"</span><span class="w"> </span>ipython<span class="w"> </span>notebook
</pre></div>
</section>
</div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/cuda/" rel="tag">cuda</a></li>
            <li><a class="tag p-category" href="../../categories/keras/" rel="tag">keras</a></li>
            <li><a class="tag p-category" href="../../categories/machine-learning/" rel="tag">machine learning</a></li>
            <li><a class="tag p-category" href="../../categories/programming/" rel="tag">programming</a></li>
            <li><a class="tag p-category" href="../../categories/python/" rel="tag">python</a></li>
            <li><a class="tag p-category" href="../../categories/ubuntu/" rel="tag">ubuntu</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../suspicious-logins/" rel="prev" title="Suspicious logins">Previous post</a>
            </li>
            <li class="next">
                <a href="../como-saber-si-hay-un-satelite-argentino-arriba-tuyo/" rel="next" title="Cómo saber si hay un satélite argentino arriba tuyo">Next post</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
        
    
        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="fisa-blog",
            disqus_url="http://blog.fisadev.com/posts/how-to-run-keras-theano-backend-with-a-nvidia-optimus-gpu-using-cuda-under-ubuntu-1604/",
        disqus_title="How to run Keras (Theano backend) with a Nvidia Optimus gpu using CUDA, under Ubuntu 16.04",
        disqus_identifier="cache/posts/how-to-run-keras-theano-backend-with-a-nvidia-optimus-gpu-using-cuda-under-ubuntu-1604.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        </section></article><script>var disqus_shortname="fisa-blog";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script><footer id="footer"><p>Contents © 2024         <a href="mailto:fisadev@gmail.com">Juan Pedro Fisanotti</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         </p>
            
        </footer>
</div>
    </div>
    <label for="sidebar-checkbox" class="sidebar-toggle"></label>
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-10031421-14"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-10031421-14');
    </script><script src="../../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates -->
</body>
</html>
